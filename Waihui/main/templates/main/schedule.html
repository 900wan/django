{% extends "main/base.html" %}
{% load i18n %} 
{% load tz %}
{% get_current_language as LANGUAGE_CODE %}
{% block title %}
    {{heading}}
{% endblock title %}

{% block content %}
{% get_current_timezone as TIME_ZONE %}
    <h1>{{heading}}{% trans "Schedule settings" %}</h1>
    <p>================================</p>
    <ul>
        {% if msg %}
            <li>{{msg}}</li>
        {% endif %}
        <li>Go <a href="{% url 'main:home' %}">home</a></li>
        <li>Time zone using in this page: {{TIME_ZONE}}, and now is {{info.now_tz|date:"Y-m-d H:i:s (O)"}}.</li>
        <li>China Standard Time(aka Beijing Time): {{now_tz|timezone:'Asia/Harbin'|date:"Y-m-d H:i:s (O)"}}</li>
        <li>Your Browser/OS local time: <span id='ltlabel'></span></li>
    </ul>
    <p>================================</p>
    {# <p id="addLi">添加列表项</p> #}
    <ul id="time_ul"></ul>
    {# <p id="collect">看看结果</p> #}
    <ul id="schedule_autoset"></ul>

    <form method="post" enctype="multipart/form-data" action="{% url 'main:schedule' %}">
        {{uf.as_p}}
        {% csrf_token %}
        <input type="submit" name="submit">
    </form>
{% endblock content %}



{% block head %}
<script type="text/javascript">
$(document).ready(function(){
//按钮的点击事件，每次点击的时候动态的创建一个  li对象，jquery直接通过 ul对象的id，使用 append 方法 动态的把li添加到ul里面

   

    var weekday=new Array(7);
    weekday[0]="日";
    weekday[1]="一";
    weekday[2]="二";
    weekday[3]="三";
    weekday[4]="四";
    weekday[5]="五";
    weekday[6]="六";

    $('#ltlabel').html(new Date().toString());
    var dateitem = new Date('{{now_tz.isoformat}}');
    var datenow = new Date(dateitem);
    dateitem.setHours(0,0,0,0);
    // alert(dateitem +'|' + datenow);
    for (var j = 0; j < 3; j++) {
        var newdayul='<li>'+weekday[dateitem.getDay()]+' '+dateitem.toDateString()+'<ul id="day_ul_'+j+'"></ul></li>';
        $("#time_ul").append(newdayul);
        for (var i = 0; i < 48; i++) {
            var dateitemstr =  new String(dateitem.getFullYear()+"-"+(dateitem.getMonth()+1)+"-"+dateitem.getDate()+" "+dateitem.toTimeString().split(" ",1)[0]);
            var msg = '<li class="timelist"><input id="'+dateitemstr+'" type="checkbox" name="'+dateitemstr+'" value="'+dateitemstr+'" /> <label for="'+dateitemstr+'"><a href="javascript:void(0)"></a><span style="">' + dateitemstr + '</span></label></li>';
            var dayul='#day_ul_'+j;
            if (datenow<dateitem) {
                $(dayul).append(msg);    
            }
            dateitem.setTime(dateitem.getTime()+30*60*1000)
        }
    }
//创建“前四项”按钮，jQuery通过模拟点击，选中3天的前四项时间段
    var appointment_time = '<li id="autoschedule"><input id=appointment_time1 type="checkbox" name="appointment_time1" value="appointment_time1" /><label for="appointment_time1"><a href="javascript:void(0)"></a><span style="">前四项</span></label></li>'
    $('#schedule_autoset').append(appointment_time)

    $("#autoschedule").find("input").click(function(){
        $(".timelist:lt(4)").each(function(){
            $(this).find("input").click();
        });
        $("#day_ul_1").find(".timelist:lt(4)").each(function(){
            $(this).find("input").click();
        });
        $("#day_ul_2").find(".timelist:lt(4)").each(function(){
            $(this).find("input").click();
        });

    })

        // $("input[type = 'checkbox']:checked").each(
        //     function(index, value){
        //         $("input[type='checkbox']").prop('checked',!$("input[type='checkbox']").prop('checked'));
        //     })
    

    $("#addLi").bind("click",function(){ 


        //每次添加万一个元素后，都会给改li绑定移除事件
        // bindListener();
    });
    //
    function getResult(){
        var schedule_result= new Array();
        $("input:checkbox:checked", ".timelist").each(function(index,value){
            var radioval =$(this).nextAll().eq(1).find("input:radio:checked").val();
            var start_time_var = $(this).val();
            schedule_result.push({
                'start_time':start_time_var,
                'topic_selector':radioval,
            });
            console.log(schedule_result);
        });
        $("#id_schedule").val(JSON.stringify(schedule_result));
    }

    //jquery 检索ul li的所有元素
    $(":checkbox", ".timelist", this).click(function(){
        var dateitemstr = $(this).next().find("span").html();
        console.log(dateitemstr);
        $topic_selector = $(
            '<ul>'
            +'<li><input id="allSku'+dateitemstr+'" type="radio" name="method_'+dateitemstr+'" value= "allSku" checked="checked" /><label for="allSku'+dateitemstr+'"><a href="javascript:void(0)"></a><span style="">All Topic</span></label>'
            +'<input id="familierSku'+dateitemstr+'" type="radio" name="method_'+dateitemstr+'" value= "familierSku" /><label for="familierSku'+dateitemstr+'"><a href="javascript:void(0)"></a><span style="">Familier Sku</span></label>'
            +'<input id="chooseSku'+dateitemstr+'" type="radio" name="method_'+dateitemstr+'" value= "chooseSku" /><label for="chooseSku'+dateitemstr+'"><a href="javascript:void(0)"></a><span style="">Choose Sku</span></label>'
            +'</li></ul>'
            )

        if ($(this).prop('checked')) {
            console.log("checked");
            $(this).parent().append(($topic_selector).clone());
        } else {
            console.log("unchecked");
            $(this).parent().find('ul').remove();
        };
        getResult();

        
        $(this).nextAll().eq(1).find("input:radio").click(function(){
            radioval = $(this).val();
            console.log(radioval);
            getResult();
        });
    })
})

</script>
{% endblock head%}